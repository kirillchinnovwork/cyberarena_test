version: "3.9"
services:
  users:
    build: services/users
    container_name: users
    environment:
      - USERS_GRPC_ADDR=:50051
      - USERS_PG_DSN=postgres://postgres:postgres@postgres:5432/news?sslmode=disable
      - USERS_S3_ENDPOINT=minio:9000
      - USERS_S3_ACCESS_KEY=minioadmin
      - USERS_S3_SECRET_KEY=minioadmin
      - USERS_S3_BUCKET=users
      - USERS_S3_USE_SSL=false
    depends_on:
      - minio
      - postgres

  news:
    build: services/news
    container_name: news
    environment:
      - NEWS_GRPC_ADDR=:50052
      - NEWS_PG_DSN=postgres://postgres:postgres@postgres:5432/news?sslmode=disable
      - NEWS_S3_ENDPOINT=minio:9000
      - NEWS_S3_ACCESS_KEY=minioadmin
      - NEWS_S3_SECRET_KEY=minioadmin
      - NEWS_S3_BUCKET=news
      - NEWS_S3_USE_SSL=false
    depends_on:
      - postgres
      - minio

  polygon:
    build: services/polygon
    container_name: polygon
    environment:
      - POLYGON_GRPC_ADDR=:50054
      - POLYGON_PG_DSN=postgres://postgres:postgres@postgres:5432/news?sslmode=disable
      - POLYGON_JWT_SECRET=dev-secret
      - POLYGON_S3_ENDPOINT=minio:9000
      - POLYGON_S3_ACCESS_KEY=minioadmin
      - POLYGON_S3_SECRET_KEY=minioadmin
      - POLYGON_S3_BUCKET=polygon
      - POLYGON_S3_USE_SSL=false
    depends_on:
      - postgres
      - minio

  auth:
    build: services/auth
    container_name: auth
    environment:
      - AUTH_GRPC_ADDR=:50053
      - AUTH_PG_DSN=postgres://postgres:postgres@postgres:5432/news?sslmode=disable
      - AUTH_JWT_SECRET=dev-secret
      - AUTH_JWT_TTL=1h
      - USERS_GRPC_ADDR=users:50051
    depends_on:
      - postgres
      - users

  clients_gateway:
    build: services/clients_gateway
    container_name: clients_gateway
    environment:
      - USERS_GRPC_ADDR=users:50051
      - NEWS_GRPC_ADDR=news:50052
      - AUTH_GRPC_ADDR=auth:50053
      - GATEWAY_HTTP_ADDR=:8080
    depends_on:
      - users
      - news
      - auth
    ports:
      - "8080:8080"

  admins_gateway:
    build: services/admins_gateway
    container_name: admins_gateway
    environment:
      - USERS_GRPC_ADDR=users:50051
      - NEWS_GRPC_ADDR=news:50052
      - AUTH_GRPC_ADDR=auth:50053
      - GATEWAY_HTTP_ADDR=:8081
    depends_on:
      - users
      - news
      - auth
    ports:
      - "8081:8081"

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=news
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

volumes:
  pgdata:
  minio-data:
