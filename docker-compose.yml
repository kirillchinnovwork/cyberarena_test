version: "3.9"
services:
  users:
    build: services/users
    container_name: users
    environment:
      - USERS_GRPC_ADDR=:50051
      - USERS_PG_DSN=postgres://postgres:postgres@postgres:5432/cyberarena?sslmode=disable
      - USERS_S3_ENDPOINT=minio:9000
      - USERS_S3_ACCESS_KEY=minioadmin
      - USERS_S3_SECRET_KEY=minioadmin
      - USERS_S3_BUCKET=users
      - USERS_S3_USE_SSL=false
    depends_on:
      - minio
      - postgres

  news:
    build: services/news
    container_name: news
    environment:
      - NEWS_GRPC_ADDR=:50052
      - NEWS_PG_DSN=postgres://postgres:postgres@postgres:5432/cyberarena?sslmode=disable
      - NEWS_S3_ENDPOINT=minio:9000
      - NEWS_S3_ACCESS_KEY=minioadmin
      - NEWS_S3_SECRET_KEY=minioadmin
      - NEWS_S3_BUCKET=news
      - NEWS_S3_USE_SSL=false
    depends_on:
      - postgres
      - minio

  polygon:
    build: services/polygon
    container_name: polygon
    environment:
      - POLYGON_GRPC_ADDR=:50054
      - POLYGON_PG_DSN=postgres://postgres:postgres@postgres:5432/cyberarena?sslmode=disable
      - POLYGON_JWT_SECRET=${JWT_SECRET:-dev-secret}
      - POLYGON_S3_ENDPOINT=minio:9000
      - POLYGON_S3_ACCESS_KEY=minioadmin
      - POLYGON_S3_SECRET_KEY=minioadmin
      - POLYGON_S3_BUCKET=polygon
      - POLYGON_S3_USE_SSL=false
      - USERS_GRPC_ADDR=users:50051
    depends_on:
      - postgres
      - minio

  attachments:
    build: services/attachments
    container_name: attachments
    environment:
      - ATTACHMENTS_GRPC_ADDR=:50055
      - ATTACHMENTS_S3_ENDPOINT=minio:9000
      - ATTACHMENTS_S3_ACCESS_KEY=minioadmin
      - ATTACHMENTS_S3_SECRET_KEY=minioadmin
      - ATTACHMENTS_S3_BUCKET=attachments
      - ATTACHMENTS_S3_USE_SSL=false
    depends_on:
      - minio

  auth:
    build: services/auth
    container_name: auth
    environment:
      - AUTH_GRPC_ADDR=:50053
      - AUTH_PG_DSN=postgres://postgres:postgres@postgres:5432/cyberarena?sslmode=disable
      - AUTH_JWT_SECRET=${JWT_SECRET:-dev-secret}
      - AUTH_JWT_TTL=1h
      - AUTH_REFRESH_TTL=720h
      - AUTH_REFRESH_COOKIE_NAME=refresh_token
      - AUTH_REFRESH_COOKIE_SECURE=false
      - USERS_GRPC_ADDR=users:50051
      - POLYGON_GRPC_ADDR=polygon:50054
    depends_on:
      - postgres
      - users

  external_controller:
    build: services/external_controller
    container_name: external_controller
    environment:
      - EXTERNAL_CONTROLLER_GRPC_ADDR=:50056
      - JENKINS_URL=${JENKINS_URL:-}
      - JENKINS_USER=${JENKINS_USER:-}
      - JENKINS_API_TOKEN=${JENKINS_API_TOKEN:-}
      - TERRAFORM_URL=${TERRAFORM_URL:-https://app.terraform.io}
      - TERRAFORM_TOKEN=${TERRAFORM_TOKEN:-}
      - TERRAFORM_ORGANIZATION=${TERRAFORM_ORGANIZATION:-}
      - SEMAPHORE_URL=${SEMAPHORE_URL:-}
      - SEMAPHORE_API_TOKEN=${SEMAPHORE_API_TOKEN:-}

  gateway:
    build: services/gateway
    container_name: gateway
    environment:
      - USERS_GRPC_ADDR=users:50051
      - NEWS_GRPC_ADDR=news:50052
      - AUTH_GRPC_ADDR=auth:50053
      - POLYGON_GRPC_ADDR=polygon:50054
      - ATTACHMENTS_GRPC_ADDR=attachments:50055
      - EXTERNAL_CONTROLLER_GRPC_ADDR=external_controller:50056
      - GATEWAY_HTTP_ADDR=:8080
      - JWT_SECRET=${JWT_SECRET:-dev-secret}
      - AUTH_REFRESH_COOKIE_NAME=refresh_token
      - GATEWAY_CORS_ORIGINS=${GATEWAY_CORS_ORIGINS:-}
      - GATEWAY_CORS_ALLOW_CREDENTIALS=true
    depends_on:
      - users
      - news
      - auth
      - polygon
      - attachments
      - external_controller
    ports:
      - "8080:8080"

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=cyberarena
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

volumes:
  pgdata:
  minio-data:
